# р╕Др╕╣р╣Ир╕бр╕╖р╕нр╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ RAG Evaluation Script

## р╕ар╕▓р╕Юр╕гр╕зр╕б

р╕кр╕Др╕гр╕┤р╕Ыр╕Хр╣Мр╕Щр╕╡р╣Йр╣Гр╕Кр╣Йр╕кр╕│р╕лр╕гр╕▒р╕Ър╕Ыр╕гр╕░р╣Ар╕бр╕┤р╕Щр╕Ыр╕гр╕░р╕кр╕┤р╕Чр╕Шр╕┤р╕ар╕▓р╕Юр╕Вр╕нр╕Зр╕гр╕░р╕Ър╕Ъ RAG (Retrieval-Augmented Generation) р╣Вр╕Фр╕вр╣Гр╕Кр╣Й Ragas framework р╕Лр╕╢р╣Ир╕Зр╕Ир╕░р╕зр╕▒р╕Фр╕Др╣Ир╕▓р╕Хр╣Ир╕▓р╕Зр╣Ж р╣Ар╕Кр╣Ир╕Щ:

- **Context Precision**: р╕Др╕зр╕▓р╕бр╣Бр╕бр╣Ир╕Щр╕вр╕│р╕Вр╕нр╕З context р╕Чр╕╡р╣Ир╕Фр╕╢р╕Зр╕бр╕▓
- **Context Recall**: р╕Др╕зр╕▓р╕бр╕Др╕гр╕нр╕Ър╕Др╕ер╕╕р╕бр╕Вр╕нр╕З context
- **Faithfulness**: р╕Др╕зр╕▓р╕бр╕Щр╣Ир╕▓р╣Ар╕Кр╕╖р╣Ир╕нр╕Цр╕╖р╕нр╕Вр╕нр╕Зр╕Др╕│р╕Хр╕нр╕Ър╕Чр╕╡р╣Ир╕нр╕┤р╕Зр╕Ир╕▓р╕Б context
- **Answer Relevancy**: р╕Др╕зр╕▓р╕бр╣Ар╕Бр╕╡р╣Ир╕вр╕зр╕Вр╣Йр╕нр╕Зр╕Вр╕нр╕Зр╕Др╕│р╕Хр╕нр╕Ър╕Бр╕▒р╕Ър╕Др╕│р╕Цр╕▓р╕б

## р╕Бр╕▓р╕гр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З

### 1. р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З Dependencies

```bash
pip install datasets ragas
```

### 2. р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ API Key

р╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣М `.env` р╣Гр╕Щр╣Вр╕Яр╕ер╣Ар╕Фр╕нр╕гр╣Мр╣Вр╕Ыр╕гр╣Ар╕Ир╕Бр╕Хр╣М:

```bash
GEMINI_API_KEY=your_api_key_here
```

р╕лр╕гр╕╖р╕нр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕Ьр╣Ир╕▓р╕Щ environment variable:

```bash
export GEMINI_API_KEY=your_api_key_here
```

### 3. р╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ (р╣Бр╕Щр╕░р╕Щр╕│)

р╕Бр╣Ир╕нр╕Щр╕гр╕▒р╕Щ evaluation р╣Гр╕лр╣Йр╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕Бр╣Ир╕нр╕Щ:

```bash
python3 test_evaluation_setup.py
```

р╕кр╕Др╕гр╕┤р╕Ыр╕Хр╣Мр╕Щр╕╡р╣Йр╕Ир╕░р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ:
- тЬЕ Environment variables (API keys)
- тЬЕ Required packages (datasets, ragas)
- тЬЕ Knowledge base files
- тЬЕ Component initialization

р╕Цр╣Йр╕▓р╕Чр╕╕р╕Бр╕нр╕вр╣Ир╕▓р╕Зр╕Ьр╣Ир╕▓р╕Щ р╕Ир╕░р╣Бр╕кр╕Фр╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б "All checks passed!"

## р╕зр╕┤р╕Шр╕╡р╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ

### р╕гр╕▒р╕Щр╕кр╕Др╕гр╕┤р╕Ыр╕Хр╣М

```bash
python3 evaluate_rag.py
```

### р╣Вр╕лр╕бр╕Фр╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ

р╣Ар╕бр╕╖р╣Ир╕нр╕гр╕▒р╕Щр╕кр╕Др╕гр╕┤р╕Ыр╕Хр╣М р╕Ир╕░р╕бр╕╡ 4 р╣Вр╕лр╕бр╕Фр╣Гр╕лр╣Йр╣Ар╕ер╕╖р╕нр╕Б:

#### 1. Quick Evaluation (р╣Бр╕Щр╕░р╕Щр╕│р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ър╣Ар╕Ър╕╖р╣Йр╕нр╕Зр╕Хр╣Йр╕Щ)
- р╣Гр╕Кр╣Йр╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╣Бр╕Ър╕Ъ Full Stack (Re-ranker + Compression)
- р╕гр╕зр╕Фр╣Ар╕гр╣Зр╕зр╣Бр╕ер╕░р╣Гр╕лр╣Йр╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕Чр╕▒р╕Щр╕Чр╕╡
- р╣Ар╕лр╕бр╕▓р╕░р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ър╣Ар╕Ър╕╖р╣Йр╕нр╕Зр╕Хр╣Йр╕Щ

#### 2. Compare All Configurations (р╣Бр╕Щр╕░р╕Щр╕│р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╣Ар╕Кр╕┤р╕Зр╕ер╕╢р╕Б)
- р╣Ар╕Ыр╕гр╕╡р╕вр╕Ър╣Ар╕Чр╕╡р╕вр╕Ъ 3 р╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓:
  - Baseline (р╣Др╕бр╣Ир╕бр╕╡ Re-ranker, р╣Др╕бр╣Ир╕бр╕╡ Compression)
  - Re-ranker Only (р╕бр╕╡р╣Бр╕Др╣И Re-ranker)
  - Full Stack (Re-ranker + Compression)
- р╣Гр╕Кр╣Йр╣Ар╕зр╕ер╕▓р╕Щр╕▓р╕Щр╕Бр╕зр╣Ир╕▓ р╣Бр╕Хр╣Ир╣Др╕Фр╣Йр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Др╕гр╕Ър╕Цр╣Йр╕зр╕Щ
- р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕Ир╕░р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Ар╕Ыр╣Зр╕Щр╣Др╕Яр╕ер╣М JSON р╣Гр╕Щр╣Вр╕Яр╕ер╣Ар╕Фр╕нр╕гр╣М `evaluation_results/`

#### 3. Custom Configuration (р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ър╣Ар╕Йр╕Юр╕▓р╕░)
- р╕Бр╕│р╕лр╕Щр╕Фр╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╣Ар╕нр╕З
- р╣Ар╕ер╕╖р╕нр╕Бр╕зр╣Ир╕▓р╕Ир╕░р╣Гр╕Кр╣Й Re-ranker р╕лр╕гр╕╖р╕нр╣Др╕бр╣И
- р╣Ар╕ер╕╖р╕нр╕Бр╕зр╣Ир╕▓р╕Ир╕░р╣Гр╕Кр╣Й Context Compression р╕лр╕гр╕╖р╕нр╣Др╕бр╣И

#### 4. Exit
- р╕нр╕нр╕Бр╕Ир╕▓р╕Бр╣Вр╕Ыр╕гр╣Бр╕Бр╕гр╕б

## р╕Бр╕▓р╕гр╣Бр╕Ыр╕ер╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М

### р╕Др╕░р╣Бр╕Щр╕Щр╣Бр╕Хр╣Ир╕ер╕░ Metric (0.0 - 1.0)

- **0.8 - 1.0**: р╕Фр╕╡р╣Ар╕вр╕╡р╣Ир╕вр╕б - р╕гр╕░р╕Ър╕Ър╕Чр╕│р╕Зр╕▓р╕Щр╣Др╕Фр╣Йр╕Фр╕╡р╕бр╕▓р╕Б
- **0.6 - 0.8**: р╕Фр╕╡ - р╕гр╕░р╕Ър╕Ър╕Чр╕│р╕Зр╕▓р╕Щр╣Др╕Фр╣Йр╕Фр╕╡ р╣Бр╕Хр╣Ир╕нр╕▓р╕Ир╕Ыр╕гр╕▒р╕Ър╕Ыр╕гр╕╕р╕Зр╣Др╕Фр╣Й
- **0.4 - 0.6**: р╕Юр╕нр╣Гр╕Кр╣Й - р╕Хр╣Йр╕нр╕Зр╕Ыр╕гр╕▒р╕Ър╕Ыр╕гр╕╕р╕З
- **0.0 - 0.4**: р╕Хр╣Йр╕нр╕Зр╣Бр╕Бр╣Йр╣Др╕В - р╕бр╕╡р╕Ыр╕▒р╕Нр╕лр╕▓р╕гр╣Йр╕▓р╕вр╣Бр╕гр╕З

### р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М

```
ЁЯУК EVALUATION RESULTS
================================================================================
Context Precision: 0.8542  тЖР р╕Фр╕╡р╕бр╕▓р╕Б
Context Recall: 0.7321     тЖР р╕Фр╕╡
Faithfulness: 0.9123       тЖР р╕Фр╕╡р╣Ар╕вр╕╡р╣Ир╕вр╕б
Answer Relevancy: 0.8654   тЖР р╕Фр╕╡р╣Ар╕вр╕╡р╣Ир╕вр╕б
================================================================================
```

## р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕Чр╕╡р╣Ир╕Ър╕▒р╕Щр╕Чр╕╢р╕Б

р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕Ир╕░р╕Цр╕╣р╕Бр╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Гр╕Щр╣Вр╕Яр╕ер╣Ар╕Фр╕нр╕гр╣М `evaluation_results/` р╣Ар╕Ыр╣Зр╕Щр╣Др╕Яр╕ер╣М JSON:

```
evaluation_results/
тФЬтФАтФА baseline_20260108_142530.json
тФЬтФАтФА reranker_only_20260108_142630.json
тФФтФАтФА full_stack_20260108_142730.json
```

р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╣Ар╕Щр╕╖р╣Йр╕нр╕лр╕▓р╣Др╕Яр╕ер╣М:

```json
{
  "config": "full_stack",
  "timestamp": "20260108_142730",
  "metrics": {
    "context_precision": 0.8542,
    "context_recall": 0.7321,
    "faithfulness": 0.9123,
    "answer_relevancy": 0.8654
  }
}
```

## р╕Бр╕▓р╕гр╕Ыр╕гр╕▒р╕Ър╣Бр╕Хр╣Ир╕З Test Cases

р╣Бр╕Бр╣Йр╣Др╕Вр╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щ `create_test_dataset()` р╣Гр╕Щр╣Др╕Яр╕ер╣М `evaluate_rag.py`:

```python
def create_test_dataset() -> List[Dict]:
    test_cases = [
        {
            "question": "р╕Др╕│р╕Цр╕▓р╕бр╕Вр╕нр╕Зр╕Др╕╕р╕У",
            "ground_truth": "р╕Др╕│р╕Хр╕нр╕Ър╕Чр╕╡р╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З"
        },
        # р╣Ар╕Юр╕┤р╣Ир╕бр╕нр╕╡р╕Б...
    ]
    return test_cases
```

## р╕Бр╕▓р╕гр╣Бр╕Бр╣Йр╣Др╕Вр╕Ыр╕▒р╕Нр╕лр╕▓

### р╕Ыр╕▒р╕Нр╕лр╕▓: ModuleNotFoundError

```bash
pip install datasets ragas
```

### р╕Ыр╕▒р╕Нр╕лр╕▓: API Key р╣Др╕бр╣Ир╕Юр╕Ъ

р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕бр╕╡р╣Др╕Яр╕ер╣М `.env` р╣Бр╕ер╕░р╕бр╕╡ `GEMINI_API_KEY` р╕нр╕вр╕╣р╣И:

```bash
cat .env
```

### р╕Ыр╕▒р╕Нр╕лр╕▓: Import Error

р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╣Др╕Яр╕ер╣М `chatbot_v04_keywords.py` р╕нр╕вр╕╣р╣Ир╣Гр╕Щр╣Вр╕Яр╕ер╣Ар╕Фр╕нр╕гр╣Мр╣Ар╕Фр╕╡р╕вр╕зр╕Бр╕▒р╕Щ

### р╕Ыр╕▒р╕Нр╕лр╕▓: Ragas Evaluation Failed

- р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╕нр╕┤р╕Щр╣Ар╕Чр╕нр╕гр╣Мр╣Ар╕Щр╣Зр╕Х
- р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ API key р╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╣Др╕Фр╣Й
- р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ test cases р╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Др╕гр╕Ър╕Цр╣Йр╕зр╕Щ

## р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Хр╕┤р╕б

### Requirements
- Python 3.8+
- datasets >= 4.4.2
- ragas >= 0.4.2
- openai (р╕кр╕│р╕лр╕гр╕▒р╕Ъ TyphoonChatbot)
- chromadb (р╕кр╕│р╕лр╕гр╕▒р╕Ъ vector database)

### Performance Tips
1. р╣Гр╕Кр╣Й Quick Evaluation р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ър╣Ар╕Ър╕╖р╣Йр╕нр╕Зр╕Хр╣Йр╕Щ
2. р╣Гр╕Кр╣Й Compare Configurations р╣Ар╕бр╕╖р╣Ир╕нр╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╣Ар╕Кр╕┤р╕Зр╕ер╕╢р╕Б
3. р╕Ыр╕гр╕▒р╕Ър╕Ир╕│р╕Щр╕зр╕Щ test cases р╣Гр╕лр╣Йр╣Ар╕лр╕бр╕▓р╕░р╕кр╕бр╕Бр╕▒р╕Ър╣Ар╕зр╕ер╕▓р╕Чр╕╡р╣Ир╕бр╕╡
4. р╣Ар╕Бр╣Зр╕Ър╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╣Др╕зр╣Йр╣Ар╕Ыр╕гр╕╡р╕вр╕Ър╣Ар╕Чр╕╡р╕вр╕Ър╣Гр╕Щр╕нр╕Щр╕▓р╕Др╕Х

## License

р╕кр╕Др╕гр╕┤р╕Ыр╕Хр╣Мр╕Щр╕╡р╣Йр╣Ар╕Ыр╣Зр╕Щр╕кр╣Ир╕зр╕Щр╕лр╕Щр╕╢р╣Ир╕Зр╕Вр╕нр╕Зр╣Вр╕Ыр╕гр╣Ар╕Ир╕Бр╕Хр╣М RAG Chatbot
